name: Refresh seasons from YouTube Playlist RSS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours

permissions:
  contents: write

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ===============================
      # SEASONS (existing logic)
      # ===============================
      - name: Fetch RSS and build season JSON files
        env:
          S1_PLAYLIST_IDS: "PLQ2KC6ajwSZy8sGySpuCkd4mZOZ14LHdW,PLQ2KC6ajwSZy0vGyHwGvLQdkUo7GraXKw"
          S2_PLAYLIST_IDS: "PLQ2KC6ajwSZzb6rS8wiz5q2uB5AzuYwOZ,PLQ2KC6ajwSZxUmuSC_6Y8x13yXssDTgZe"
        run: |
          node - <<'NODE'
          const fs = require("fs");

          async function fetchText(url) {
            const res = await fetch(url, { headers: { "User-Agent": "Mozilla/5.0" } });
            if (!res.ok) throw new Error(`Fetch failed ${res.status}`);
            return await res.text();
          }

          function decodeXml(s) {
            return String(s || "")
              .replaceAll("&amp;", "&")
              .replaceAll("&lt;", "<")
              .replaceAll("&gt;", ">")
              .replaceAll("&quot;", '"')
              .replaceAll("&#39;", "'");
          }

          function tag(xml, name) {
            const m = xml.match(new RegExp(`<${name}[^>]*>([\\s\\S]*?)<\\/${name}>`));
            return m ? m[1].trim() : "";
          }

          function attr(xml, name) {
            const m = xml.match(new RegExp(`${name}="([^"]+)"`));
            return m ? m[1] : "";
          }

          function parseEntries(feedXml) {
            return feedXml.split("<entry>").slice(1).map(x => x.split("</entry>")[0]);
          }

          function extractEpNumber(title) {
            const m = title?.match(/\bEP\s*([0-9]{1,3})\b/i);
            return m ? Number(m[1]) : null;
          }

          function itemsFromFeed(feedXml, seasonNumber) {
            return parseEntries(feedXml).map(entry => {
              const title = decodeXml(tag(entry, "title"));
              const published = tag(entry, "published");
              const date = published ? published.slice(0, 10) : null;
              const videoId = tag(entry, "yt:videoId");

              const linkTag = entry.match(/<link[^>]+>/)?.[0] || "";
              const youtube = attr(linkTag, "href") || `https://www.youtube.com/watch?v=${videoId}`;

              const description = decodeXml(tag(entry, "media:description"));
              const thumbTag = entry.match(/<media:thumbnail[^>]+>/)?.[0] || "";
              const thumbnail = attr(thumbTag, "url") || `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;

              const ep = extractEpNumber(title);
              const id = ep ? `s${seasonNumber}e${ep}` : `s${seasonNumber}-${videoId}`;

              return { id, season: seasonNumber, episode: ep, title, date, youtube, thumbnail, description, videoId };
            });
          }

          async function buildSeason(seasonNumber, playlists) {
            const feeds = await Promise.all(
              playlists.split(",").map(id =>
                fetchText(`https://www.youtube.com/feeds/videos.xml?playlist_id=${id.trim()}`)
              )
            );

            const map = new Map();
            feeds.forEach(xml => {
              itemsFromFeed(xml, seasonNumber).forEach(i => map.set(i.videoId, i));
            });

            return [...map.values()]
              .sort((a, b) => (b.date || "").localeCompare(a.date || ""))
              .map(({ videoId, ...rest }) => rest);
          }

          (async () => {
            const s1 = await buildSeason(1, process.env.S1_PLAYLIST_IDS);
            const s2 = await buildSeason(2, process.env.S2_PLAYLIST_IDS);

            fs.mkdirSync("data", { recursive: true });
            fs.writeFileSync("data/season1.json", JSON.stringify(s1, null, 2));
            fs.writeFileSync("data/season2.json", JSON.stringify(s2, null, 2));

            console.log(`Season 1: ${s1.length}`);
            console.log(`Season 2: ${s2.length}`);
          })();
          NODE

      # ===============================
      # SHORTS (NEW)
      # ===============================
      - name: Fetch Shorts playlist RSS
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const PLAYLIST_ID = "PLQ2KC6ajwSZxf5fdSpF9CQpVTTZSklN9k";
          const RSS = `https://www.youtube.com/feeds/videos.xml?playlist_id=${PLAYLIST_ID}`;

          async function fetchText(url){
            const res = await fetch(url, { headers: { "User-Agent": "Mozilla/5.0" }});
            return await res.text();
          }

          function tag(xml, name){
            const m = xml.match(new RegExp(`<${name}[^>]*>([\\s\\S]*?)<\\/${name}>`));
            return m ? m[1].trim() : "";
          }

          function attr(xml, name){
            const m = xml.match(new RegExp(`${name}="([^"]+)"`));
            return m ? m[1] : "";
          }

          (async () => {
            const xml = await fetchText(RSS);
            const entries = xml.split("<entry>").slice(1);

            const shorts = entries.map(e => {
              const videoId = tag(e, "yt:videoId");
              const title = tag(e, "title");
              const published = tag(e, "published");
              const thumbTag = e.match(/<media:thumbnail[^>]+>/)?.[0] || "";

              return {
                id: videoId,
                title,
                date: published?.slice(0,10),
                url: `https://www.youtube.com/watch?v=${videoId}`,
                thumbnail: attr(thumbTag, "url") || `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`
              };
            });

            fs.writeFileSync("data/shorts.json", JSON.stringify(shorts.slice(0,50), null, 2));
            console.log(`Shorts: ${shorts.length}`);
          })();
          NODE

      # ===============================
      # COMMIT
      # ===============================
      - name: Commit JSON updates
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/*.json
          git commit -m "chore: refresh podcast data from YouTube RSS"
          git push
